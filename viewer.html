<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹œíŠ¸ ë·°ì–´</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      margin:0; padding:16px; background:#f3f4f6; color:#111827;
    }
    .card{
      max-width:1100px; margin:0 auto; background:#fff; border-radius:12px;
      padding:16px 20px 20px; box-shadow:0 10px 25px rgba(15,23,42,0.08);
    }
    h1{font-size:20px; margin:0 0 4px;}
    .sub{font-size:12px; color:#6b7280; margin-bottom:8px;}
    .folder-label{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; color:#4b5563; margin-bottom:12px;
      padding:4px 8px; border-radius:999px; background:#eff6ff;
    }

    .sheet-menu{display:flex; gap:6px; overflow-x:auto; padding-bottom:4px; margin-bottom:8px;}
    .sheet-tab{
      flex:0 0 auto; padding:6px 14px; font-size:13px; border-radius:999px;
      border:1px solid #d1d5db; background:#f9fafb; color:#4b5563; cursor:pointer;
      white-space:nowrap; transition:background .15s,color .15s,border-color .15s;
    }
    .sheet-tab:hover{background:#e5e7eb;}
    .sheet-tab.active{
      background:#3b82f6; border-color:#2563eb; color:#fff; font-weight:600;
    }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;
    }
    button{
      border-radius:999px; border:none; padding:6px 14px; font-size:13px; cursor:pointer;
      background:#3b82f6; color:#fff; display:inline-flex; align-items:center; gap:4px;
    }
    button:disabled{opacity:.6; cursor:default;}
    button.secondary{background:#e5e7eb; color:#374151;}
    .status{font-size:12px; color:#6b7280;}

    table{
      width:100%; border-collapse:collapse; margin-top:8px;
      font-size:13px; table-layout:fixed;
    }
    thead{background:#f9fafb;}
    th,td{
      border-bottom:1px solid #e5e7eb; padding:6px 8px; text-align:left;
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    th{font-weight:600; font-size:12px; color:#4b5563;}
    tbody tr:nth-child(even){background:#f9fafb;}
    .empty{
      padding:20px 4px; text-align:center; font-size:13px; color:#9ca3af;
    }
    .warn{
      padding:8px 12px; border-radius:8px;
      background:#fef3c7; color:#92400e; font-size:12px; margin-bottom:8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="pageTitle">ì‹œíŠ¸ ë·°ì–´</h1>
    <div id="pageSub" class="sub"></div>
    <div id="folderLabel" class="folder-label" style="display:none;">
      <span>ğŸ“ ë“œë¼ì´ë¸Œ í´ë”:</span>
      <strong id="folderName">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</strong>
    </div>

    <div id="warnBox" class="warn" style="display:none;">
      âš ï¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ì—†ì–´ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
      URL ë’¤ì— <code>?id=ìŠ¤í”„ë ˆë“œì‹œíŠ¸ID</code> í˜•íƒœë¡œ ì ‘ì†í•´ì•¼ í•©ë‹ˆë‹¤.
    </div>

    <!-- ì‹œíŠ¸ íƒ­ ë©”ë‰´ (í•œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì•ˆì˜ ì—¬ëŸ¬ íƒ­) -->
    <div id="sheetMenu" class="sheet-menu"></div>

    <!-- íˆ´ë°” -->
    <div class="toolbar">
      <button id="refreshBtn" onclick="reloadCurrentSheet()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button class="secondary" onclick="location.reload()">âŸ³ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
      <span id="status" class="status"></span>
    </div>

    <!-- ë°ì´í„° í…Œì´ë¸” -->
    <div style="overflow:auto; max-height:480px;">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // â˜…â˜…â˜… ì—¬ê¸°ë§Œ ë„¤ ê°’ìœ¼ë¡œ ë°”ê¾¸ë©´ ë¨ â˜…â˜…â˜…

    // 1) Google Cloud Consoleì—ì„œ ë§Œë“  "API í‚¤" (ì§€ê¸ˆ ë„¤ê°€ ì¤€ ê°’)
    const API_KEY = 'AIzaSyDcyBVuyykaAEj0Fy7jJqzV1qCBfc82xkU';  // â† ì—¬ê¸°ì— ë„¤ í‚¤ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°

    // 2) ì‚¬ìš©í•  ë“œë¼ì´ë¸Œ í´ë” ID (ë„¤ê°€ ì¤€ ë§í¬ì—ì„œ ì¶”ì¶œí•œ ê°’)
    const FOLDER_ID = '1t33dy_UQCfsvoEQ9yOctIxvoT623i-j4';

    // URL íŒŒë¼ë¯¸í„° ì½ê¸°: id, sheet, title
    const params = new URLSearchParams(location.search);
    const SPREADSHEET_ID = params.get('id') || params.get('sheet') || ''; // ì‹œíŠ¸ ID
    const TITLE_PARAM     = params.get('title') || '';                     // í˜ì´ì§€ ì œëª© (ì„ íƒ)

    let currentSheetName = '';

    function setStatus(msg){
      document.getElementById('status').textContent = msg || '';
    }
    function setLoading(isLoading,msg){
      const btn = document.getElementById('refreshBtn');
      btn.disabled = isLoading || !currentSheetName;
      setStatus(msg || (isLoading ? 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦' : ''));
    }

    // ë“œë¼ì´ë¸Œ í´ë” ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    async function fetchFolderName() {
      if (!FOLDER_ID) return null;

      try {
        const url =
          `https://www.googleapis.com/drive/v3/files/${FOLDER_ID}` +
          `?fields=name&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) {
          console.warn('í´ë” ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨:', res.status);
          return null;
        }
        const json = await res.json();
        return json.name || null;
      } catch (err) {
        console.error('í´ë” ì´ë¦„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', err);
        return null;
      }
    }

    // ì‹œíŠ¸ íƒ­(ë“¤) ì´ë¦„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í•œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë‚´ íƒ­ë“¤)
    async function fetchSheetNames(spreadsheetId) {
      const url =
        `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}` +
        `?fields=sheets.properties.title&key=${API_KEY}`;

      const res = await fetch(url);
      if (!res.ok) {
        throw new Error('ì‹œíŠ¸ ëª©ë¡ HTTP ' + res.status);
      }
      const json = await res.json();
      const names = (json.sheets || []).map(s => s.properties.title);
      return names;
    }

    // ì´ˆê¸° ì„¤ì • (ì œëª©/í´ë”ëª…/íƒ­ ëª©ë¡)
    async function initPage(){
      const titleEl = document.getElementById('pageTitle');
      const subEl   = document.getElementById('pageSub');
      const warnBox = document.getElementById('warnBox');
      const folderLabel = document.getElementById('folderLabel');
      const folderNameEl = document.getElementById('folderName');

      // ì œëª© ì„¸íŒ…
      if (TITLE_PARAM) {
        titleEl.textContent = TITLE_PARAM;
        subEl.textContent = 'ì´ í˜ì´ì§€ëŠ” "' + (TITLE_PARAM) + '"ì— ì—°ê²°ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.';
      } else {
        subEl.textContent = 'URLì— title íŒŒë¼ë¯¸í„°ë¥¼ ë„£ìœ¼ë©´ ê°œë³„ í˜ì´ì§€ëª…ì„ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      }

      // í´ë” ì´ë¦„ í‘œì‹œ
      folderLabel.style.display = 'inline-flex';
      fetchFolderName().then(name => {
        folderNameEl.textContent = name || '(í´ë” ì´ë¦„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤)';
      });

      // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID ì—†ìœ¼ë©´ ì¢…ë£Œ
      if (!SPREADSHEET_ID) {
        warnBox.style.display = 'block';
        setLoading(false, '');
        return;
      }

      setLoading(true, 'ì‹œíŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');

      const menu = document.getElementById('sheetMenu');
      menu.innerHTML = '';

      try {
        const sheetNames = await fetchSheetNames(SPREADSHEET_ID);

        if (!sheetNames.length) {
          setLoading(false, 'ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸(íƒ­)ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // íƒ­ ë²„íŠ¼ ìƒì„±
        sheetNames.forEach(name => {
          const tab = document.createElement('button');
          tab.className = 'sheet-tab';
          tab.textContent = name;
          tab.dataset.name = name;
          tab.onclick = () => selectSheet(name);
          menu.appendChild(tab);
        });

        // ê¸°ë³¸: ì²« ë²ˆì§¸ íƒ­ ìë™ ì„ íƒ
        currentSheetName = sheetNames[0];
        highlightActiveTab(currentSheetName);
        loadDataForSheet(currentSheetName);
      } catch (err) {
        console.error(err);
        setLoading(false, 'ì‹œíŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + err.message);
      }
    }

    function highlightActiveTab(name){
      document.querySelectorAll('.sheet-tab').forEach(tab=>{
        tab.classList.toggle('active', tab.dataset.name === name);
      });
    }

    function selectSheet(name){
      if (!name) return;
      currentSheetName = name;
      highlightActiveTab(name);
      loadDataForSheet(name);
    }

    function reloadCurrentSheet(){
      if(!currentSheetName) return;
      loadDataForSheet(currentSheetName);
    }

    // ì‹¤ì œ ë°ì´í„°(ê°’) ê°€ì ¸ì˜¤ê¸°
    async function loadDataForSheet(sheetName){
      setLoading(true, `"${sheetName}" ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
      try{
        const range = encodeURIComponent(sheetName); // ì‹œíŠ¸ ì „ì²´
        const url =
          `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}` +
          `?key=${API_KEY}`;
        const res = await fetch(url);
        if(!res.ok){
          throw new Error('HTTP ' + res.status);
        }
        const json = await res.json();
        const values = json.values || [];
        renderTable(values);
        const now = new Date();
        setLoading(false, `[${sheetName}] ë§ˆì§€ë§‰ ê°±ì‹ : ` + now.toLocaleString());
      }catch(err){
        console.error(err);
        setLoading(false, 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + err.message);
      }
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(values){
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      if(!values || !values.length){
        tbody.innerHTML = '<tr><td class="empty">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      const headers = values[0];
      const rows = values.slice(1);

      const trHead = document.createElement('tr');
      headers.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      if(!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = headers.length || 1;
        td.className = 'empty';
        td.textContent = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(row=>{
        const tr = document.createElement('tr');
        headers.forEach((_,i)=>{
          const td = document.createElement('td');
          td.textContent = row[i] ?? '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    window.addEventListener('load', initPage);
  </script>
</body>
</html>
